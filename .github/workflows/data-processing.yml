name: Veri Ä°ÅŸleme ve GÃ¼ncelleme

on:
  push:
    branches: [ main ]
    paths: 
      - 'data/raw/**'
      - 'scripts/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'data/raw/**'
      - 'scripts/**'
  schedule:
    # Her ayÄ±n 1'inde 02:00'da Ã§alÄ±ÅŸ (UTC)
    - cron: '0 2 1 * *'
  workflow_dispatch:

jobs:
  validate-and-process:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
      
    - name: ğŸ Python Kurulumu
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ” Script Syntax KontrolÃ¼
      run: |
        python quick_syntax_check.py
        
    - name: ğŸ¥ SaÄŸlÄ±k BakanlÄ±ÄŸÄ± Verileri Ã‡ek
      continue-on-error: true
      run: |
        python scripts/fetch_saglik_bakanligi_data.py
        
    - name: ğŸ¥ Ã–zel Hastaneler Verileri Ã‡ek
      continue-on-error: true
      run: |
        python scripts/fetch_ozel_hastaneler_data.py
        
    - name: ğŸ“ Ãœniversite Hastaneleri Ã‡ek
      continue-on-error: true
      run: |
        python scripts/fetch_universite_hastaneleri.py
    - name: ğŸŒ TR Hastane Ek Verileri Ã‡ek (Opsiyonel)
      continue-on-error: true
      run: |
        python scripts/fetch_trhastane_data.py
        
    - name: âœ… Veri DoÄŸrulama
      run: |
        python scripts/validate_data.py
        
    - name: âš™ï¸ Veri Ä°ÅŸleme
      run: |
        python scripts/process_data.py
        
    - name: ğŸ”§ Ã‡ankÄ±rÄ± Ä°l HatasÄ± DÃ¼zeltme
      run: |
        python fix_cankiri.py
        
    - name: ğŸ§¹ Veri Temizleme
      run: |
        python clean_all_data.py
        
    - name: ğŸ¯ Deploy HazÄ±rlÄ±k KontrolÃ¼
      run: |
        python final_deploy_check.py
        
    - name: ğŸ“Š Veri Ä°statistikleri
      run: |
        echo "ğŸ“Š Ä°ÅŸlenmiÅŸ Veri Ä°statistikleri:"
        python -c "import json; data=json.load(open('data/turkiye_saglik_kuruluslari.json','r',encoding='utf-8')); print(f'ğŸ“ˆ Toplam Kurum: {len(data.get(\"kurumlar\",[]))}'); print(f'ğŸ—ºï¸ Toplam Ä°l: {data.get(\"meta\",{}).get(\"toplam_il\",\"?\")}')"
        
    - name: ğŸ’¾ DeÄŸiÅŸiklikleri Commit Et
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        git add -A
        
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "ğŸ¤– Otomatik veri gÃ¼ncelleme - $(date '+%Y-%m-%d %H:%M UTC')"
          git push
        else
          echo "ğŸ“ GÃ¼ncellenecek veri yok"
        fi
        
    - name: ğŸŒ GitHub Pages iÃ§in HazÄ±rla
      if: github.ref == 'refs/heads/main'
      run: |
        mkdir -p public
        cp -r web/* public/ 2>/dev/null || cp *.html public/ 2>/dev/null || true
        cp -r js public/ 2>/dev/null || true
        cp -r css public/ 2>/dev/null || true  
        cp -r styles public/ 2>/dev/null || true
        cp data/turkiye_saglik_kuruluslari.json public/
        ls -la public/
        
    - name: ğŸš€ GitHub Pages'e Deploy
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
      
    - name: ğŸ Python Kurulumu
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ” Script Syntax KontrolÃ¼
      run: |
        python quick_syntax_check.py
        
    - name: âœ… Veri DoÄŸrulama Testi
      run: |
        python scripts/validate_data.py
        
    - name: âš™ï¸ Veri Ä°ÅŸleme Testi (Dry Run)
      run: |
        echo "ğŸ§ª Veri iÅŸleme testi yapÄ±lÄ±yor..."
        python scripts/process_data.py --dry-run 2>/dev/null || python scripts/process_data.py
        
    - name: ğŸ“‹ Test SonuÃ§larÄ±nÄ± Raporla
      if: always()
      run: |
        echo "âœ… Pull Request Testleri TamamlandÄ±"
        echo "ğŸ“Š Veri doÄŸrulama: BaÅŸarÄ±lÄ±"
        echo "ğŸ”„ Veri iÅŸleme: BaÅŸarÄ±lÄ±"
        echo "ğŸ¯ PR merge iÃ§in hazÄ±r!"
