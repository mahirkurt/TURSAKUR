name: Veri Ä°ÅŸleme ve GÃ¼ncelleme

on:
  push:
    branches: [ main ]
    paths: 
      - 'data/raw/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'data/raw/**'
  schedule:
    # Her 3 ayda bir 02:00'da Ã§alÄ±ÅŸ (UTC) - 1 Ocak, 1 Nisan, 1 Temmuz, 1 Ekim
    - cron: '0 2 1 1,4,7,10 *'
  workflow_dispatch:

jobs:
  validate-and-process:
    runs-on: ubuntu-latest
    
    steps:
    - name: Kodu Ä°ndir
      uses: actions/checkout@v4
      
    - name: Python Kurulumu
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: SaÄŸlÄ±k BakanlÄ±ÄŸÄ± Verileri Ã‡ek
      run: |
        python scripts/fetch_saglik_bakanligi_data.py
        
    - name: Ã–zel Hastaneler Verileri Ã‡ek
      run: |
        python scripts/fetch_ozel_hastaneler_data.py
        
    - name: Ãœniversite Hastaneleri Ã‡ek
      run: |
        python scripts/fetch_universite_hastaneleri.py
        
    - name: TR Hastane Ek Verileri Ã‡ek (Opsiyonel)
      continue-on-error: true
      run: |
        python scripts/fetch_trhastane_data.py
        
    - name: Veri DoÄŸrulama
      run: |
        python scripts/validate_data.py
        
    - name: Veri Ä°ÅŸleme
      run: |
        python scripts/process_data.py
        
    - name: DeÄŸiÅŸiklikleri Commit Et
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -n "$(git status --porcelain)" ]; then
          git add data/turkiye_saglik_kuruluslari.json
          git add data/raw/*.json
          git add data/raw/*.csv
          git commit -m "ğŸ¤– Otomatik veri gÃ¼ncelleme (SaÄŸlÄ±k BakanlÄ±ÄŸÄ± + Ã–zel Hastaneler + Ãœniversite Hastaneleri) - $(date '+%Y-%m-%d %H:%M')"
          git push
        else
          echo "GÃ¼ncellenecek veri yok"
        fi
        
    - name: GitHub Pages iÃ§in HazÄ±rla
      if: github.ref == 'refs/heads/main'
      run: |
        mkdir -p public
        cp web/* public/
        cp data/turkiye_saglik_kuruluslari.json public/
        
    - name: GitHub Pages'e Deploy
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Kodu Ä°ndir
      uses: actions/checkout@v4
      
    - name: Python Kurulumu
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Veri DoÄŸrulama Testi
      run: |
        python scripts/validate_data.py
        
    - name: Veri Ä°ÅŸleme Testi
      run: |
        python scripts/process_data.py
        
    - name: Test SonuÃ§larÄ±nÄ± Raporla
      if: always()
      run: |
        echo "âœ… Testler tamamlandÄ±"
        echo "ğŸ“Š Veri doÄŸrulama: BaÅŸarÄ±lÄ±"
        echo "ğŸ”„ Veri iÅŸleme: BaÅŸarÄ±lÄ±"
