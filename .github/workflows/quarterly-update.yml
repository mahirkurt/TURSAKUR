name: TURSAKUR Quarterly Data Update

on:
  schedule:
    # Her 3 ayda bir Ã§alÄ±ÅŸtÄ±r (1 Ocak, 1 Nisan, 1 Temmuz, 1 Ekim - 02:00 UTC)
    - cron: '0 2 1 1,4,7,10 *'
  
  # Manuel tetikleme iÃ§in
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ZamanÄ±ndan Ã¶nce gÃ¼ncellemeyi zorla'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  quarterly-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Repository'yi checkout et
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ Python kurulumu
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸ“ Gerekli dizinleri oluÅŸtur
      run: |
        mkdir -p data/raw
        mkdir -p logs
        mkdir -p backups
    
    - name: ðŸ”§ Git kullanÄ±cÄ± bilgilerini ayarla
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: ðŸ” GÃ¼ncelleme gerekli mi kontrol et
      id: check_update
      run: |
        if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          echo "update_needed=true" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Manuel gÃ¼ncelleme tetiklendi"
        else
          python -c "
          import sys
          sys.path.append('scripts')
          from quarterly_update import QuarterlyUpdater
          updater = QuarterlyUpdater()
          needed = updater.should_run_update()
          print(f'update_needed={str(needed).lower()}')
          " >> $GITHUB_OUTPUT
        fi
    
    - name: ðŸš€ ÃœÃ§ aylÄ±k gÃ¼ncellemeyi Ã§alÄ±ÅŸtÄ±r
      if: steps.check_update.outputs.update_needed == 'true'
      run: |
        echo "ðŸ”„ ÃœÃ§ aylÄ±k veri gÃ¼ncelleme baÅŸlatÄ±lÄ±yor..."
        python scripts/quarterly_update.py
      continue-on-error: false
    
    - name: ðŸ“Š GÃ¼ncelleme sonuÃ§larÄ±nÄ± kontrol et
      if: steps.check_update.outputs.update_needed == 'true'
      id: check_results
      run: |
        if [ -f "data/turkiye_saglik_kuruluslari.json" ]; then
          RECORD_COUNT=$(python -c "
          import json
          with open('data/turkiye_saglik_kuruluslari.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          print(len(data))
          ")
          echo "record_count=$RECORD_COUNT" >> $GITHUB_OUTPUT
          echo "success=true" >> $GITHUB_OUTPUT
          echo "âœ… GÃ¼ncelleme baÅŸarÄ±lÄ±: $RECORD_COUNT kayÄ±t"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "âŒ GÃ¼ncelleme baÅŸarÄ±sÄ±z: Ana veri dosyasÄ± bulunamadÄ±"
        fi
    
    - name: ðŸ“ˆ GitHub Pages iÃ§in hazÄ±rla
      if: steps.check_update.outputs.update_needed == 'true' && steps.check_results.outputs.success == 'true'
      run: |
        echo "ðŸŒ GitHub Pages iÃ§in veri hazÄ±rlanÄ±yor..."
        
        # Ana veri dosyasÄ±nÄ± web dizinine kopyala
        cp data/turkiye_saglik_kuruluslari.json web/data/
        
        # Dosya boyutunu kontrol et
        FILE_SIZE=$(stat -c%s "data/turkiye_saglik_kuruluslari.json")
        echo "ðŸ“Š Veri dosyasÄ± boyutu: $(($FILE_SIZE / 1024 / 1024)) MB"
        
        # SÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ versiyon oluÅŸtur
        if command -v gzip &> /dev/null; then
          gzip -c data/turkiye_saglik_kuruluslari.json > web/data/turkiye_saglik_kuruluslari.json.gz
          echo "ðŸ—œï¸ SÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ dosya oluÅŸturuldu"
        fi
    
    - name: ðŸ“ DeÄŸiÅŸiklik raporunu oku
      if: steps.check_update.outputs.update_needed == 'true'
      id: read_report
      run: |
        REPORT_DATE=$(date +%Y-%m-%d)
        REPORT_FILE="logs/quarterly_report_${REPORT_DATE}.txt"
        
        if [ -f "$REPORT_FILE" ]; then
          # Raporu GitHub Actions Ã¶zet olarak ekle
          echo "## TURSAKUR ÃœÃ§ AylÄ±k GÃ¼ncelleme Raporu" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
          
          # Rapor iÃ§eriÄŸini environment variable olarak ayarla
          {
            echo 'REPORT_CONTENT<<EOF'
            cat "$REPORT_FILE"
            echo EOF
          } >> $GITHUB_ENV
        fi
    
    - name: ðŸ“¤ DeÄŸiÅŸiklikleri commit et
      if: steps.check_update.outputs.update_needed == 'true' && steps.check_results.outputs.success == 'true'
      run: |
        # DeÄŸiÅŸen dosyalarÄ± kontrol et
        if git diff --quiet; then
          echo "â„¹ï¸ Commit edilecek deÄŸiÅŸiklik yok"
        else
          echo "ðŸ“ DeÄŸiÅŸiklikler commit ediliyor..."
          
          # GÃ¼ncellenmiÅŸ dosyalarÄ± staging area'ya ekle
          git add data/turkiye_saglik_kuruluslari.json
          git add data/update_metadata.json
          git add web/data/
          git add logs/quarterly_report_*.txt
          
          # Commit mesajÄ±nÄ± oluÅŸtur
          COMMIT_MSG="ðŸ”„ ÃœÃ§ aylÄ±k veri gÃ¼ncellemesi - $(date '+%Y-%m-%d')

          ðŸ“Š KayÄ±t sayÄ±sÄ±: ${{ steps.check_results.outputs.record_count }}
          ðŸ¤– Otomatik gÃ¼ncelleme
          
          [skip ci]"
          
          git commit -m "$COMMIT_MSG"
          git push
          
          echo "âœ… DeÄŸiÅŸiklikler baÅŸarÄ±yla push edildi"
        fi
    
    - name: ðŸ·ï¸ Release oluÅŸtur
      if: steps.check_update.outputs.update_needed == 'true' && steps.check_results.outputs.success == 'true'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: data-update-${{ github.run_number }}
        release_name: TURSAKUR Veri GÃ¼ncellemesi - $(date '+%Y-%m-%d')
        body: |
          ## ðŸ”„ ÃœÃ§ AylÄ±k Otomatik Veri GÃ¼ncellemesi
          
          **ðŸ“… GÃ¼ncelleme Tarihi:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          **ðŸ“Š Toplam KayÄ±t:** ${{ steps.check_results.outputs.record_count }} saÄŸlÄ±k kurumu
          **ðŸ¤– GÃ¼ncelleme Tipi:** Otomatik Ã¼Ã§ aylÄ±k gÃ¼ncelleme
          
          ### ðŸ“ GÃ¼ncellenmiÅŸ Dosyalar
          - `data/turkiye_saglik_kuruluslari.json` - Ana veri dosyasÄ±
          - `web/data/` - GitHub Pages veri dosyalarÄ±
          - GÃ¼ncelleme raporlarÄ±
          
          ### ðŸ”— BaÄŸlantÄ±lar
          - [CanlÄ± Web Sitesi](https://tursakur.web.app)
          - [Ana Veri DosyasÄ±](https://github.com/${{ github.repository }}/blob/main/data/turkiye_saglik_kuruluslari.json)
          
          ---
          Bu gÃ¼ncelleme GitHub Actions tarafÄ±ndan otomatik olarak oluÅŸturulmuÅŸtur.
        draft: false
        prerelease: false
    
    - name: ðŸ”” Discord bildirim gÃ¶nder
      if: steps.check_update.outputs.update_needed == 'true' && steps.check_results.outputs.success == 'true'
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        if [ -n "$DISCORD_WEBHOOK" ]; then
          curl -H "Content-Type: application/json" \
               -d "{
                 \"embeds\": [{
                   \"title\": \"ðŸ”„ TURSAKUR Veri GÃ¼ncellemesi\",
                   \"description\": \"ÃœÃ§ aylÄ±k otomatik veri gÃ¼ncellemesi tamamlandÄ±\",
                   \"color\": 3066993,
                   \"fields\": [
                     {\"name\": \"ðŸ“Š KayÄ±t SayÄ±sÄ±\", \"value\": \"${{ steps.check_results.outputs.record_count }}\", \"inline\": true},
                     {\"name\": \"ðŸ“… Tarih\", \"value\": \"$(date '+%Y-%m-%d')\", \"inline\": true},
                     {\"name\": \"ðŸŒ Web Sitesi\", \"value\": \"[tursakur.web.app](https://tursakur.web.app)\", \"inline\": true}
                   ],
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                 }]
               }" \
               "$DISCORD_WEBHOOK"
        fi
    
    - name: ðŸ“Š Ä°statistik Ã¶zeti
      if: steps.check_update.outputs.update_needed == 'true'
      run: |
        echo "## ðŸ“ˆ TURSAKUR GÃ¼ncelleme Ã–zeti" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ¥ Toplam SaÄŸlÄ±k Kurumu:** ${{ steps.check_results.outputs.record_count || 'Bilinmiyor' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ“… GÃ¼ncelleme Tarihi:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ”„ GÃ¼ncelleme Durumu:** ${{ steps.check_results.outputs.success == 'true' && 'âœ… BaÅŸarÄ±lÄ±' || 'âŒ BaÅŸarÄ±sÄ±z' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸŒ Web Sitesi:** [tursakur.web.app](https://tursakur.web.app)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check_results.outputs.success }}" = "true" ]; then
          echo "ðŸŽ‰ GÃ¼ncelleme baÅŸarÄ±yla tamamlandÄ±!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ GÃ¼ncelleme sÄ±rasÄ±nda sorunlar oluÅŸtu." >> $GITHUB_STEP_SUMMARY
        fi

  # Backup job - baÅŸarÄ±sÄ±z gÃ¼ncellemeler iÃ§in
  backup-on-failure:
    runs-on: ubuntu-latest
    needs: quarterly-update
    if: failure()
    
    steps:
    - name: âš ï¸ BaÅŸarÄ±sÄ±z gÃ¼ncelleme bildirimi
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        if [ -n "$DISCORD_WEBHOOK" ]; then
          curl -H "Content-Type: application/json" \
               -d "{
                 \"embeds\": [{
                   \"title\": \"âš ï¸ TURSAKUR GÃ¼ncelleme HatasÄ±\",
                   \"description\": \"ÃœÃ§ aylÄ±k otomatik veri gÃ¼ncellemesi baÅŸarÄ±sÄ±z oldu\",
                   \"color\": 15158332,
                   \"fields\": [
                     {\"name\": \"ðŸ“… Tarih\", \"value\": \"$(date '+%Y-%m-%d %H:%M:%S UTC')\", \"inline\": true},
                     {\"name\": \"ðŸ”— Detaylar\", \"value\": \"[GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": true}
                   ],
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                 }]
               }" \
               "$DISCORD_WEBHOOK"
        fi
        
        echo "âŒ GÃ¼ncelleme baÅŸarÄ±sÄ±z oldu - lÃ¼tfen loglarÄ± kontrol edin" >> $GITHUB_STEP_SUMMARY
